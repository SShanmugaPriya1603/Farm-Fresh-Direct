<!DOCTYPE html>
<html lang="en">
<head>
    <style>
        .lang-switcher-container { margin-left: 20px; }
        .lang-switcher-container select { padding: 5px; border-radius: 4px; border: 1px solid #ccc; }
        .nav-actions { display: flex; align-items: center; }
    </style>
    <meta charset="UTF-8">
    <title>Farmer Dashboard</title>
    <link rel="stylesheet" href="style.css">
    <style>
        .dashboard-grid { display: grid; grid-template-columns: 1fr 2fr; gap: 30px; max-width: 1200px; margin: 30px auto; padding: 0 20px; }
        .form-container, .list-container { background: #fff; padding: 20px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); }
        #my-products-list { display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 20px; }
        .farmer-product-card { border: 1px solid #eee; border-radius: 8px; overflow: hidden; text-align: center; transition: transform 0.2s, box-shadow 0.2s; }
        .farmer-product-card:hover { transform: translateY(-5px); box-shadow: 0 8px 15px rgba(0,0,0,0.1); }
        .farmer-product-card img { width: 100%; height: 120px; object-fit: cover; }
        .farmer-product-card .card-content { padding: 15px; }
        .farmer-product-card h4 { margin-bottom: 5px; font-size: 1.1rem; }
        .farmer-product-card .price { color: #0a7c2f; font-weight: bold; margin-bottom: 15px; }
        .product-actions { display: flex; justify-content: space-around; }
        .product-actions button { width: 48%; padding: 8px; border-radius: 4px; border: none; cursor: pointer; font-weight: bold; }
        .edit-btn { background-color: #ffc107; }
        .delete-btn { background-color: #dc3545; color: white; }
        #cancelEditBtn { background-color: #6c757d; color: white; display: none; }
    </style>
</head>
<body>
    <header>
        <nav class="navbar">
            <div class="logo">
                <img src="assets/logo.png" alt="Logo">
                <span>Farm Fresh Direct - Farmer Portal</span>
            </div>
            <ul class="nav-links">
                <li><a href="/farmer.html" data-i18n="my_products">My Products</a></li>
                <li><a href="/farmer-orders.html" data-i18n="orders">Orders</a></li>
                <li><a href="/soil-info.html" data-i18n="soil_info">Soil Info</a></li>
                <li><a href="/farmer-qna.html" data-i18n="qna">Q&A</a></li>
                <li><a href="/crop-insurance.html" data-i18n="schemes_insurance">Schemes & Insurance</a></li>
                <li><a href="/farmer-profile.html" data-i18n="profile">Profile</a></li>
            </ul>
            <div class="nav-actions">
                <div class="lang-switcher-container">
                    <select id="language-switcher">
                        <option value="en">English</option>
                        <option value="hi">हिन्दी</option>
                        <option value="ta">தமிழ்</option>
                    </select>
                </div>
                <a href="/index.html" class="btn-login" id="logout-btn" data-i18n="logout">Logout</a>
            </div>
        </nav>
    </header>

    <main class="dashboard-grid">
        <div class="form-container">
            <h3 data-i18n="add_new_product">Add New Product</h3>
            <form id="addProductForm">
                <input type="hidden" id="productId">
                <div>
                    <label for="productName" data-i18n="product_name">Product Name:</label>
                    <input type="text" id="productName" required>
                </div>
                <div>
                    <label for="productPrice" data-i18n="price_per_kg">Price (per kg):</label>
                    <input type="number" id="productPrice" step="0.01" required>
                </div>
                <div>
                    <label for="productImage" data-i18n="image_url_optional">Image URL (optional):</label>
                    <input type="text" id="productImage" placeholder="e.g., /assets/products/new.jpg">
                </div>
                <div class="form-actions" style="gap: 10px;">
                    <button type="submit" class="btn-primary" style="width: 100%; margin-top: 10px;" data-i18n="add_product">Add Product</button>
                    <button type="button" id="cancelEditBtn" class="btn-secondary" style="width: 100%; margin-top: 10px;" data-i18n="cancel_edit">Cancel Edit</button>
                </div>
            </form>
        </div>

        <div class="list-container">
            <h3 data-i18n="my_product_listings">My Product Listings</h3>
            <div id="my-products-list">
                <div class="spinner-container"><div class="spinner"></div></div>
            </div>
        </div>
    </main>

    <script>
        document.getElementById('logout-btn').addEventListener('click', (e) => {
            e.preventDefault();
            localStorage.clear();
            window.location.href = '/index.html';
        });

        document.addEventListener('DOMContentLoaded', async () => {
            const farmerId = localStorage.getItem('userId');
            if (!farmerId || localStorage.getItem('userRole') !== 'farmer') {
                window.location.href = '/index.html';
                return;
            }

            const addProductForm = document.getElementById('addProductForm');
            const myProductsList = document.getElementById('my-products-list');
            const formTitle = document.querySelector('.form-container h3');
            const submitButton = addProductForm.querySelector('button[type="submit"]');
            const cancelEditBtn = document.getElementById('cancelEditBtn');
            const productIdInput = document.getElementById('productId');
            let allProducts = [];

            async function fetchAndRenderProducts() {
                const res = await fetch(`/api/products/farmer/${farmerId}`);
                const products = await res.json();
                myProductsList.innerHTML = '';
                if (products.length === 0) {
                    myProductsList.innerHTML = `<p data-i18n="no_products_listed">${await translate('no_products_listed')}</p>`;
                } else {
                    allProducts = products; // Store for editing
                    products.forEach(p => {
                        const card = document.createElement('div');
                        card.className = 'farmer-product-card';
                        card.innerHTML = `
                            <img src="${p.image}" alt="${p.name}">
                            <div class="card-content">
                                <h4>${p.name}</h4>
                                <p class="price">₹${p.price.toFixed(2)} / kg</p>
                                <div class="product-actions">
                                    <button class="edit-btn" data-id="${p._id}" data-i18n="edit">Edit</button>
                                    <button class="delete-btn" data-id="${p._id}" data-i18n="delete">Delete</button>
                                </div>
                            </div>
                        `;
                        myProductsList.appendChild(card);
                    });
                }
            }

            addProductForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                const productId = productIdInput.value;
                const isEditing = !!productId;

                const productData = {
                    name: document.getElementById('productName').value,
                    price: document.getElementById('productPrice').value,
                    image: document.getElementById('productImage').value || undefined,
                    farmerId: farmerId
                };

                const url = isEditing ? `/api/products/${productId}` : '/api/products';
                const method = isEditing ? 'PUT' : 'POST';

                const res = await fetch(url, {
                    method: method,
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(productData)
                });

                if (res.ok) {
                    resetForm();
                    fetchAndRenderProducts();
                } else {
                    alert(await translate(isEditing ? 'failed_to_update' : 'failed_to_add'));
                }
            });

            myProductsList.addEventListener('click', async (e) => {
                const target = e.target;
                const id = target.dataset.id;

                if (target.classList.contains('delete-btn')) {
                    if (confirm(await translate('confirm_delete'))) {
                        const res = await fetch(`/api/products/${id}`, {
                            method: 'DELETE',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ farmerId }) // Send farmerId for verification
                        });
                        if (res.ok) {
                            fetchAndRenderProducts();
                        } else {
                            const data = await res.json();
                            alert('Error: ' + data.msg);
                        }
                    }
                }

                if (target.classList.contains('edit-btn')) {
                    const productToEdit = allProducts.find(p => p._id === id);
                    if (productToEdit) {
                        formTitle.textContent = await translate('edit_product');
                        submitButton.textContent = await translate('update_product');
                        cancelEditBtn.style.display = 'block';

                        document.getElementById('productId').value = productToEdit._id;
                        document.getElementById('productName').value = productToEdit.name;
                        document.getElementById('productPrice').value = productToEdit.price;
                        document.getElementById('productImage').value = productToEdit.image;

                        window.scrollTo({ top: 0, behavior: 'smooth' });
                    }
                }
            });

            function resetForm() {
                formTitle.textContent = translations['add_new_product'] || 'Add New Product';
                submitButton.textContent = translations['add_product'] || 'Add Product';
                cancelEditBtn.style.display = 'none';
                addProductForm.reset();
                productIdInput.value = '';
            }

            cancelEditBtn.addEventListener('click', resetForm);
            
            // --- I18n Logic ---
            const languageSwitcher = document.getElementById('language-switcher');
            let translations = {};

            async function setLanguage(lang) {
                localStorage.setItem('language', lang);
                languageSwitcher.value = lang;
                
                const response = await fetch(`/locales/${lang}.json`);
                translations = await response.json();

                document.querySelectorAll('[data-i18n]').forEach(elem => {
                    const key = elem.getAttribute('data-i18n');
                    if (translations[key]) {
                        if (elem.placeholder !== undefined && elem.tagName.toLowerCase() !== 'button') {
                            elem.placeholder = translations[key];
                        } else {
                            elem.textContent = translations[key];
                        }
                    }
                });
            }

            async function translate(key) {
                if (translations[key]) return translations[key];
                // Fallback to english if translation not loaded yet
                const response = await fetch(`/locales/en.json`);
                const enTranslations = await response.json();
                return enTranslations[key] || key;
            }

            languageSwitcher.addEventListener('change', (e) => setLanguage(e.target.value));

            // Set initial language and then fetch products
            const savedLang = localStorage.getItem('language') || 'en';
            await setLanguage(savedLang);
            await fetchAndRenderProducts();
        });
    </script>
</body>
</html>
```
